# Model Context Protocol (MCP) 通用Demo

一个基于Model Context Protocol的智能AI助手demo，支持多种功能模块的集成和扩展。

## 📋 项目简介

本项目实现了一个可扩展的MCP框架，包含以下核心功能：

1. **本地函数调用** - 调用税务计算器等本地计算函数
2. **网站数据查询** - 查询香港天文台天气信息
3. **本地数据库查询** - 支持模糊查询token价格数据
4. **智能综合处理** - 结合多个功能模块的AI智能分析

## 🏗️ 工程结构

```
mcp/
├── mcp_demo.py              # 主程序文件
├── tax_calculator.py        # 本地函数示例（税务计算器）
├── token_price.csv          # 本地数据库示例（CSV格式）
├── token_price.json         # 本地数据库示例（JSON格式）
├── README.md               # 项目说明文档
└── requirements.txt        # 依赖包列表
```

## 🔧 安装依赖

### 1. Python环境要求
- Python 3.8+

### 2. 安装依赖包

```bash
pip install -r requirements.txt
```

### 3. 依赖包说明

- `openai` - OpenAI API客户端
- `dashscope` - 阿里云通义千问API客户端
- `pandas` - 数据处理和分析
- `requests` - HTTP请求库
- `beautifulsoup4` - 网页解析库
- `lxml` - XML/HTML解析器

## 🚀 使用方法

### 启动程序

```bash
cd mcp
python mcp_demo.py
```

**⚠️ 重要提示：请务必在 `mcp` 目录下运行程序！**

程序需要读取 `token_price.csv` 和 `token_price.json` 数据文件，这些文件位于 `mcp` 目录下。如果从其他目录运行程序，将显示"⚠️ 未找到token价格数据文件"错误。

### 功能菜单

程序启动后会显示以下功能选项：

1. **📊 调用本地函数 (税务计算)**
   - 输入月工资总额、五险一金、专项附加扣除
   - 自动计算个人所得税

2. **🌤️ 查询香港天气**
   - 获取香港天文台实时天气信息
   - 包含温度、湿度、天气状况等

3. **💰 查询本地数据库 (token价格)**
   - 支持模糊查询，如"查询2025-01-03 8点 aixbt的价格"
   - 智能解析时间、币种等查询条件

4. **🤖 智能综合处理**
   - 结合多个功能模块的AI智能分析
   - 例如："帮我查香港天气，决定穿什么"

## 📝 使用示例

### 示例1：税务计算
```
请输入月工资总额（元）: 20000
请输入月五险一金（元，默认0）: 3000
请输入月专项附加扣除（元，默认0）: 1000

计算结果:
  应缴税额: ¥840.00 (monthly)
  实际税率: 5.04%
  边际税率: 10.0%
```

### 示例2：数据库查询
```
请输入查询内容: 查询2025-01-03 8点 aixbt的价格

查询结果:
  币种: aixbt
  价格: $0.489715
  时间: 2025-01-03 08:03:55
  市值: $491,432,406.53
```

### 示例3：智能综合处理
```
请描述您的需求: 帮我查一查香港的天气，然后决定我出门穿什么，要不要带伞

AI建议:
根据当前香港天气信息，今天是多云有几阵骤雨，温度24-28°C，湿度75-90%。
建议穿着：
- 轻便的长袖衬衫或薄外套
- 长裤
- 舒适的鞋子
必需品：
- 一定要带雨伞！
- 可考虑带轻便雨衣
```

## 🔄 扩展指南

### 添加新的本地函数模块

1. 在项目目录下创建新的Python文件（如 `new_calculator.py`）
2. 在 `mcp_demo.py` 中导入新模块
3. 在 `MCPDemo` 类中添加对应的处理方法
4. 在菜单中添加新选项

### 添加新的数据源

1. 准备数据文件（CSV、JSON等格式）
2. 在 `_load_token_data()` 方法中添加数据加载逻辑
3. 在 `search_token_price()` 方法中添加查询逻辑

### 添加新的API接口

1. 在类初始化中添加API配置
2. 创建对应的查询方法
3. 在智能处理模块中添加关键词检测

## 🧪 测试用例

### 1. 税务计算测试

```python
# 测试用例1：低收入
输入: 工资5000, 五险一金500, 专项扣除0
预期: 税额0（低于起征点）

# 测试用例2：中等收入
输入: 工资15000, 五险一金2000, 专项扣除1000
预期: 税额约360元

# 测试用例3：高收入
输入: 工资50000, 五险一金5000, 专项扣除2000
预期: 税额约10000元
```

### 2. 数据库查询测试

```python
# 测试用例1：精确时间查询
查询: "2025-01-03 8点 aixbt"
预期: 返回2025-01-03 08:XX:XX的aixbt价格数据

# 测试用例2：模糊币种查询
查询: "luna价格"
预期: 返回luna-by-virtuals的最新价格

# 测试用例3：日期范围查询
查询: "1月3日 vaderai"
预期: 返回2025-01-03的vaderai相关数据
```

### 3. 智能处理测试

```python
# 测试用例1：天气相关
输入: "今天天气怎么样，要带伞吗"
预期: 获取天气信息并给出建议

# 测试用例2：价格相关
输入: "aixbt现在多少钱"
预期: 查询最新价格并分析

# 测试用例3：综合查询
输入: "查天气和token价格，给我分析一下"
预期: 同时获取两类信息并综合分析
```

## ⚠️ 注意事项

1. **运行目录**：**必须在 `mcp` 目录下运行程序**，否则无法加载token价格数据文件
2. **API密钥配置**：请确保OpenAI和通义千问的API密钥有效
3. **网络连接**：天气查询功能需要稳定的网络连接
4. **数据文件**：确保token_price.csv和token_price.json文件存在于 `mcp` 目录下
5. **依赖安装**：运行前请安装所有必需的依赖包

## 🔧 故障排除

### 常见问题

1. **数据文件加载失败** ⭐ **最常见问题**
   - **错误信息**：`⚠️ 未找到token价格数据文件`
   - **原因**：程序运行目录不正确
   - **解决方案**：
     ```bash
     # 错误的运行方式（在项目根目录下）
     python mcp/mcp_demo.py  ❌
     
     # 正确的运行方式（在mcp目录下）
     cd mcp
     python mcp_demo.py  ✅
     ```
   - **检查**：确认当前目录下有 `token_price.csv` 和 `token_price.json` 文件

2. **API调用失败**
   - 检查API密钥是否正确
   - 确认网络连接正常
   - 检查API配额是否充足

3. **数据格式错误**
   - 确认数据文件路径正确
   - 检查文件格式是否正确
   - 确认文件权限

4. **模块导入错误**
   - 检查Python环境和依赖包
   - 确认所有文件在同一目录下

## 📞 技术支持

如有问题或建议，请：
1. 检查本README中的故障排除部分
2. 查看代码中的中文注释
3. 运行测试用例验证功能

## 📄 许可证

本项目仅供学习和演示使用。 
